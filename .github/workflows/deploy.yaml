name: Deploy Node Health Watcher

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH key
        run: |
          set -euo pipefail
          install -m 700 -d ~/.ssh
          printf '%s\n' "${{ secrets.CONTROL_PLANE_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Copy manifests to control-plane
        env:
          SSH_HOST: ${{ secrets.CONTROL_PLANE_HOST }}
          SSH_USER: ${{ secrets.CONTROL_PLANE_USER }}
          SSH_PORT: ${{ secrets.CONTROL_PLANE_PORT }}
        run: |
          set -euo pipefail
          PORT="${SSH_PORT:-22}"
          ssh -p "$PORT" -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} 'mkdir -p /tmp/node-health-watcher'
          scp -P "$PORT" -o StrictHostKeyChecking=no k8s/*.yaml ${SSH_USER}@${SSH_HOST}:/tmp/node-health-watcher/
          scp -P "$PORT" -o StrictHostKeyChecking=no src/watcher/main.py requirements.txt ${SSH_USER}@${SSH_HOST}:/tmp/node-health-watcher/

      - name: Deploy manifests
        env:
          SSH_HOST: ${{ secrets.CONTROL_PLANE_HOST }}
          SSH_USER: ${{ secrets.CONTROL_PLANE_USER }}
          SSH_PORT: ${{ secrets.CONTROL_PLANE_PORT }}
        run: |
          set -euo pipefail
          PORT="${SSH_PORT:-22}"
          ssh -p "$PORT" -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} "
            sudo k3s kubectl apply -f /tmp/node-health-watcher/namespace.yaml &&
            sudo k3s kubectl apply -f /tmp/node-health-watcher/rbac.yaml &&
            sudo k3s kubectl apply -f /tmp/node-health-watcher/configmap.yaml &&
            sudo k3s kubectl -n monitoring create configmap node-health-watcher-code \
              --from-file=main.py=/tmp/node-health-watcher/main.py \
              --from-file=requirements.txt=/tmp/node-health-watcher/requirements.txt \
              --dry-run=client -o yaml | sudo k3s kubectl apply -f - &&
            sudo k3s kubectl apply -f /tmp/node-health-watcher/deployment.yaml &&
            sudo k3s kubectl -n monitoring rollout status deployment/node-health-watcher --timeout=120s
          "
